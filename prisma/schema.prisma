generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// B2B2C User Management
model User {
  id                String     @id @default(cuid())
  email             String     @unique
  name              String?
  role              UserRole   @default(BUSINESS_OWNER)
  plan              Plan       @default(STANDARD)
  passwordHash      String

  // Relations
  ownedBusinesses   Business[] @relation("BusinessOwner")
  createdBusinesses Business[] @relation("BusinessCreator")

  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt

  @@index([email])
}

enum Plan {
  STANDARD
  PREMIUM
}

enum UserRole {
  ADMIN          // Mafalia employees - full access
  BUSINESS_OWNER // Business clients - read-only dashboard
}

enum BusinessType {
  RESTAURANT
  RETAIL
  SERVICE
}

model users_sync {
  id         String    @id
  name       String?
  email      String?
  created_at DateTime
  updated_at DateTime
  deleted_at DateTime?
  raw_json   Json
}

model Business {
  id                    String         @id @default(cuid())
  name                  String
  description           String
  cuisine               String
  whatsappNumber        String
  whatsappPhoneNumberId String         @default("")
  whatsappAccessToken   String?        @default("")
  whatsappAppSecret     String?        @default("")
  webhookVerifyToken    String         @default("")
  supportedLanguages    Json
  isActive              Boolean        @default(true)
  isConcierge           Boolean        @default(false)
  businessType          BusinessType   @default(RESTAURANT)
  userId                String
  welcomeMessage        String         @default("")
  businessHours         String         @default("")
  specialInstructions   String         @default("")
  orderingEnabled       Boolean        @default(true)
  deliveryInfo          String         @default("")
  ownerAgeRange         String?
  ownerSex              String?
  country               String?
  activitySector        String?
  verificationCode      String?
  isVerified            Boolean        @default(false)

  // LAM Integration
  lamApiKey             String?
  lamBaseUrl            String?        @default("https://waba.lafricamobile.com")

  // B2B2C Fields
  ownerId               String?
  owner                 User?          @relation("BusinessOwner", fields: [ownerId], references: [id])
  createdById           String?
  createdBy             User?          @relation("BusinessCreator", fields: [createdById], references: [id])

  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  apiKeyCreatedAt       DateTime?
  apiKeyHash            String?
  apiKeyRevokedAt       DateTime?

  conversations         Conversation[]
  menuItems             MenuItem[]
  messageLogs           MessageLog[]
  orders                Order[]
  knowledgeDocs         KnowledgeDoc[]

  @@index([userId])
  @@index([ownerId])
  @@index([createdById])
}

model MenuItem {
  id          String   @id @default(cuid())
  businessId  String
  name        String
  description String
  price       Int
  category    String?
  isAvailable Boolean  @default(true)
  imageUrl    String?
  embedding   Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt
  business    Business @relation(fields: [businessId], references: [id])
}

model Conversation {
  id          String   @id @default(cuid())
  businessId  String
  phoneNumber String
  messages    Json
  metadata    Json?
  lastActive  DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  business    Business @relation(fields: [businessId], references: [id])

  @@index([businessId, phoneNumber])
}

model Order {
  id           String      @id @default(cuid())
  businessId   String
  customerName String
  phoneNumber  String
  items        Json
  total        Int
  notes        String?
  status       OrderStatus @default(pending)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  business     Business    @relation(fields: [businessId], references: [id])

  @@index([businessId, createdAt])
}

model MessageLog {
  id                String           @id @default(cuid())
  businessId        String
  phoneNumber       String
  whatsappMessageId String
  direction         MessageDirection
  messageType       String?
  templateName      String?
  status            String
  errorCode         String?
  errorTitle        String?
  errorDetail       String?
  raw               Json?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  business          Business         @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId, createdAt])
  @@index([whatsappMessageId])
}

model KnowledgeDoc {
  id          String           @id @default(cuid())
  businessId  String
  business    Business         @relation(fields: [businessId], references: [id], onDelete: Cascade)
  filename    String
  mimeType    String
  contentText String
  chunks      KnowledgeChunk[]
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@index([businessId])
}

model KnowledgeChunk {
  id         String       @id @default(cuid())
  docId      String
  doc        KnowledgeDoc @relation(fields: [docId], references: [id], onDelete: Cascade)
  businessId String
  content    String
  embedding  Json?
  chunkIndex Int
  createdAt  DateTime     @default(now())

  @@index([businessId])
}

enum OrderStatus {
  pending
  confirmed
  preparing
  delivered
  cancelled
}

enum MessageDirection {
  inbound
  outbound
}

model SystemLog {
  id        String   @id @default(cuid())
  level     String
  message   String
  metadata  Json?
  source    String
  timestamp DateTime @default(now())

  @@index([level])
  @@index([source])
  @@index([timestamp])
}
